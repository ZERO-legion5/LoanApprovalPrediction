{% extends "base.html" %}

{% block content %}
<div class="row g-4">
    <!-- Input Section -->
    <div class="col-lg-7">
        <div class="card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">Applicant Details</h3>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="autofill()">
                    <i class="bi bi-shuffle"></i> Regenerate Data
                </button>
            </div>
            
            <form id="predictionForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Dependents</label>
                        <input type="number" class="form-control auto-trigger" name="no_of_dependents" id="no_of_dependents" min="0" max="5">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Education</label>
                        <select class="form-select auto-trigger" name="education" id="education">
                            <option value="1">Graduate</option>
                            <option value="0">Not Graduate</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Self Employed</label>
                        <select class="form-select auto-trigger" name="self_employed" id="self_employed">
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Annual Income (₹)</label>
                        <input type="number" class="form-control auto-trigger" name="income_annum" id="income_annum">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Loan Amount (₹)</label>
                        <input type="number" class="form-control auto-trigger" name="loan_amount" id="loan_amount">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tenure (Years)</label>
                        <input type="number" class="form-control auto-trigger" name="loan_tenure" id="loan_tenure">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">CIBIL Score</label>
                        <input type="number" class="form-control auto-trigger" name="cibil_score" id="cibil_score">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Residential Asset (₹)</label>
                        <input type="number" class="form-control auto-trigger" name="residential_asset_value" id="residential_asset_value">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Commercial Asset (₹)</label>
                        <input type="number" class="form-control auto-trigger" name="commercial_asset_value" id="commercial_asset_value">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Luxury Asset (₹)</label>
                        <input type="number" class="form-control auto-trigger" name="luxury_asset_value" id="luxury_asset_value">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Bank Assets (₹)</label>
                        <input type="number" class="form-control auto-trigger" name="bank_assets_value" id="bank_assets_value">
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Section with Tabs -->
    <div class="col-lg-5">
        <div class="card p-4 h-100 bg-dark text-white border-0 shadow-lg">
            <ul class="nav nav-pills mb-4 justify-content-center" id="resultTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="approval-tab" data-bs-toggle="pill" data-bs-target="#approval" type="button" role="tab">Loan Approval</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="risk-tab" data-bs-toggle="pill" data-bs-target="#risk" type="button" role="tab">Risk Score</button>
                </li>
            </ul>

            <div id="loadingOverlay" class="text-center py-5 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Analyzing...</p>
            </div>

            <div class="tab-content" id="resultTabContent">
                <!-- Approval Tab -->
                <div class="tab-pane fade show active" id="approval" role="tabpanel">
                    <div id="approvalContent">
                        <div class="text-center mb-5">
                            <p class="text-uppercase small tracking-widest opacity-75">Final Consensus</p>
                            <h1 id="finalStatus" class="display-3 fw-bold mb-0">--</h1>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <div class="p-3 bg-secondary bg-opacity-10 rounded">
                                    <p class="small mb-1 opacity-75">Decision Tree</p>
                                    <h5 id="dtResult" class="mb-0">--</h5>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-secondary bg-opacity-10 rounded">
                                    <p class="small mb-1 opacity-75">Random Forest</p>
                                    <h5 id="rfResult" class="mb-0">--</h5>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-secondary bg-opacity-10 rounded">
                                    <p class="small mb-1 opacity-75">Naive Bayes</p>
                                    <h5 id="nbResult" class="mb-0">--</h5>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-secondary bg-opacity-10 rounded">
                                    <p class="small mb-1 opacity-75">XGBoost</p>
                                    <h5 id="xgbResult" class="mb-0">--</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Score Tab -->
                <div class="tab-pane fade" id="risk" role="tabpanel">
                    <div class="text-center py-4">
                        <p class="text-uppercase small tracking-widest opacity-75 mb-4">Creditworthiness Score</p>
                        
                        <div class="position-relative d-inline-block">
                            <svg width="200" height="200" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#333" stroke-width="8" />
                                <circle id="scoreCircle" cx="50" cy="50" r="45" fill="none" stroke="#0d6efd" stroke-width="8" 
                                        stroke-dasharray="282.7" stroke-dashoffset="282.7" stroke-linecap="round" 
                                        transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 1s ease-out;" />
                                <text x="50" y="55" font-family="Arial" font-size="20" fill="white" text-anchor="middle" font-weight="bold" id="riskScoreText">0</text>
                            </svg>
                        </div>

                        <div class="mt-4">
                            <h4 id="riskLabel" class="text-primary fw-bold">Calculating...</h4>
                            <p id="riskDesc" class="small opacity-75 px-4 mt-2">
                                Based on ML probability analysis and asset-to-debt ratios.
                            </p>
                        </div>

                        <div class="mt-5 text-start px-3">
                            <div class="d-flex justify-content-between mb-1 small opacity-75">
                                <span>High Risk</span>
                                <span>Medium</span>
                                <span>Low Risk</span>
                            </div>
                            <div class="progress" style="height: 6px; background: #333;">
                                <div id="riskBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-auto pt-4">
                <div class="p-3 rounded bg-primary bg-opacity-10 border border-primary border-opacity-25">
                    <p class="small mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Real-time data synchronization enabled.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function autofill() {
        const fields = {
            'no_of_dependents': () => getRandomInt(0, 5),
            'education': () => getRandomInt(0, 1),
            'self_employed': () => getRandomInt(0, 1),
            'income_annum': () => getRandomInt(500000, 9500000),
            'loan_tenure': () => getRandomInt(2, 20),
            'cibil_score': () => getRandomInt(300, 900),
            'residential_asset_value': () => getRandomInt(1000000, 25000000),
            'commercial_asset_value': () => getRandomInt(500000, 15000000),
            'luxury_asset_value': () => getRandomInt(1000000, 35000000),
            'bank_assets_value': () => getRandomInt(200000, 12000000)
        };

        for (const [id, generator] of Object.entries(fields)) {
            document.getElementById(id).value = generator();
        }

        const income = parseInt(document.getElementById('income_annum').value);
        document.getElementById('loan_amount').value = getRandomInt(income, income * 3);

        updatePrediction();
    }

    async function updatePrediction() {
        const form = document.getElementById('predictionForm');
        const formData = new FormData(form);
        
        for (let [key, value] of formData.entries()) {
            if (!value) return;
        }

        const loadingOverlay = document.getElementById('loadingOverlay');
        const approvalContent = document.getElementById('approvalContent');
        
        loadingOverlay.classList.remove('d-none');

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            // Update Approval UI
            const finalStatus = document.getElementById('finalStatus');
            finalStatus.innerText = data.final_result;
            finalStatus.className = 'display-3 fw-bold mb-0 ' + (data.final_result === 'Approved' ? 'text-success' : 'text-danger');

            document.getElementById('dtResult').innerText = data.individual_results.dt;
            document.getElementById('rfResult').innerText = data.individual_results.rf;
            document.getElementById('nbResult').innerText = data.individual_results.nb;
            document.getElementById('xgbResult').innerText = data.individual_results.xgb;

            const updateColor = (id, result) => {
                const el = document.getElementById(id);
                el.className = 'mb-0 ' + (result === 'Approved' ? 'text-success' : 'text-danger');
            };

            updateColor('dtResult', data.individual_results.dt);
            updateColor('rfResult', data.individual_results.rf);
            updateColor('nbResult', data.individual_results.nb);
            updateColor('xgbResult', data.individual_results.xgb);

            // Update Risk Score UI
            const score = data.success_score;
            document.getElementById('riskScoreText').textContent = score;
            
            const circle = document.getElementById('scoreCircle');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (score / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // Color circle based on score
            if (score > 70) circle.style.stroke = "#198754";
            else if (score > 40) circle.style.stroke = "#ffc107";
            else circle.style.stroke = "#dc3545";

            const riskLabel = document.getElementById('riskLabel');
            const riskBar = document.getElementById('riskBar');
            riskBar.style.width = score + '%';
            
            if (score > 80) {
                riskLabel.textContent = "Excellent";
                riskLabel.className = "text-success fw-bold";
                riskBar.className = "progress-bar bg-success";
            } else if (score > 60) {
                riskLabel.textContent = "Good";
                riskLabel.className = "text-info fw-bold";
                riskBar.className = "progress-bar bg-info";
            } else if (score > 40) {
                riskLabel.textContent = "Fair";
                riskLabel.className = "text-warning fw-bold";
                riskBar.className = "progress-bar bg-warning";
            } else {
                riskLabel.textContent = "High Risk";
                riskLabel.className = "text-danger fw-bold";
                riskBar.className = "progress-bar bg-danger";
            }

        } catch (error) {
            console.error('Prediction error:', error);
        } finally {
            loadingOverlay.classList.add('d-none');
        }
    }

    document.querySelectorAll('.auto-trigger').forEach(input => {
        input.addEventListener('input', () => {
            clearTimeout(window.predictionTimer);
            window.predictionTimer = setTimeout(updatePrediction, 300);
        });
    });

    window.onload = autofill;
</script>
<style>
    .tracking-widest { letter-spacing: 0.2em; }
    .nav-pills .nav-link { color: #888; border-radius: 8px; font-weight: 500; }
    .nav-pills .nav-link.active { background-color: #0d6efd !important; color: white; }
    .card { transition: all 0.3s ease; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.05) !important; }
    .bg-dark { background: #1a1c1e !important; }
    #scoreCircle { transition: stroke-dashoffset 1s ease-in-out, stroke 0.5s ease; }
</style>
{% endblock %}
